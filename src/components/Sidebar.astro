---
/**
 * Sidebar navigation component.
 * - Responsive: collapses to hamburger menu on mobile, close button inline with logo
 * - Branding: uses d-logo.svg
 * - Download Resume button replaces version badge
 * - Active state updated via ScrollSpy on home page
 */
import dLogo from "../assets/d-logo.svg";

interface Props {
  currentPath?: string;
}

const { currentPath = "/" } = Astro.props;
const isHome = currentPath === "/";

interface NavItem {
  id: string; // section ID
  icon: string;
  label: string;
}

const mainStructure: NavItem[] = [
  { id: "summary", icon: "dashboard", label: "Executive Summary" },
  { id: "services", icon: "handyman", label: "Services" },
  { id: "history", icon: "work_history", label: "Work History" },
  { id: "projects", icon: "apps", label: "Projects" },
  { id: "stack", icon: "layers", label: "Stack Index" },
];

// Helper to generate correct href
const getHref = (id: string) => (isHome ? `#${id}` : `/#${id}`);

const resumeUrl = "#";
---

<!-- Mobile Hamburger Button (visible only when sidebar is closed) -->
<button
  id="menu-toggle"
  class="fixed top-4 left-4 z-[60] md:hidden w-10 h-10 flex items-center justify-center bg-black dark:bg-white rounded-md shadow-lg"
  aria-label="Toggle menu"
>
  <span class="material-symbols-outlined text-white dark:text-black text-xl"
    >menu</span
  >
</button>

<!-- Overlay (mobile only) -->
<div
  id="sidebar-overlay"
  class="fixed inset-0 bg-black/50 z-40 hidden md:hidden transition-opacity duration-300"
>
</div>

<!-- Sidebar -->
<aside
  id="sidebar"
  class="fixed h-screen w-64 border-r border-slate-100 dark:border-slate-900 bg-white dark:bg-[#050505] z-50 overflow-y-auto transition-transform duration-300 -translate-x-full md:translate-x-0"
>
  <!-- Branding row: logo + close button -->
  <div class="p-6 pb-4">
    <div class="flex items-center justify-between">
      <a href="/" class="block">
        <img src={dLogo.src} alt="Logo" class="h-10 w-auto" />
      </a>
      <!-- Close button: inline, only visible on mobile when sidebar is open -->
      <button
        id="menu-close"
        class="md:hidden w-8 h-8 flex items-center justify-center rounded-md hover:bg-slate-100 dark:hover:bg-slate-800 transition-colors"
        aria-label="Close menu"
      >
        <span
          class="material-symbols-outlined text-black dark:text-white text-lg"
          >close</span
        >
      </button>
    </div>
    <div
      class="flex items-center gap-1 text-[9px] font-bold text-slate-500 mt-2"
    >
      <span class="w-1.5 h-1.5 rounded-full bg-accent"></span>
      BUILDING PIXEL-PERFECT APPS
    </div>
  </div>

  <!-- Navigation -->
  <nav class="mt-8 space-y-1">
    {
      mainStructure.map((item) => (
        <a
          class:list={["sidebar-link", "nav-item"]}
          href={getHref(item.id)}
          data-target={item.id}
        >
          <span class="material-symbols-outlined nav-icon">{item.icon}</span>
          {item.label}
        </a>
      ))
    }

    <div class="h-px bg-slate-100 dark:bg-slate-900 my-4 mx-6"></div>

    <a
      class:list={["sidebar-link", { active: currentPath === "/contact" }]}
      href="/contact"
    >
      <span class="material-symbols-outlined nav-icon">mail</span>
      Contact
    </a>
  </nav>

  <!-- Download Resume -->
  <div class="absolute bottom-8 left-8 right-8">
    <a
      href={resumeUrl}
      target="_blank"
      rel="noopener noreferrer"
      class="flex items-center justify-center gap-2 p-3 bg-black text-white dark:bg-white dark:text-black text-[9px] leading-tight font-bold uppercase tracking-wider hover:opacity-80 transition-opacity"
    >
      <span class="material-symbols-outlined text-sm">download</span>
      Download Resume
    </a>
  </div>
</aside>

<script>
  // Mobile Menu Logic
  const toggleBtn = document.getElementById("menu-toggle");
  const closeBtn = document.getElementById("menu-close");
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("sidebar-overlay");

  function openSidebar() {
    sidebar?.classList.remove("-translate-x-full");
    sidebar?.classList.add("translate-x-0");
    overlay?.classList.remove("hidden");
    toggleBtn?.classList.add("hidden");
  }

  function closeSidebar() {
    sidebar?.classList.add("-translate-x-full");
    sidebar?.classList.remove("translate-x-0");
    overlay?.classList.add("hidden");
    toggleBtn?.classList.remove("hidden");
  }

  toggleBtn?.addEventListener("click", openSidebar);
  closeBtn?.addEventListener("click", closeSidebar);
  overlay?.addEventListener("click", closeSidebar);

  // Close sidebar on link click (mobile)
  sidebar?.querySelectorAll(".sidebar-link").forEach((link) => {
    link.addEventListener("click", () => {
      if (window.innerWidth < 768) {
        closeSidebar();
      }
    });
  });

  // Scroll Spy Logic (only if on home page)
  if (window.location.pathname === "/") {
    const navLinks = document.querySelectorAll(".nav-item");
    const sections = document.querySelectorAll("section[id]");

    const observerOptions = {
      root: null,
      rootMargin: "-20% 0px -70% 0px", // adjust to trigger active state earlier/later
      threshold: 0,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // Remove active from all
          navLinks.forEach((link) => link.classList.remove("active"));
          // Add active to current
          const id = entry.target.getAttribute("id");
          const activeLink = document.querySelector(
            `.nav-item[data-target="${id}"]`,
          );
          if (activeLink) {
            activeLink.classList.add("active");
          }
        }
      });
    }, observerOptions);

    sections.forEach((section) => {
      observer.observe(section);
    });
  }
</script>
